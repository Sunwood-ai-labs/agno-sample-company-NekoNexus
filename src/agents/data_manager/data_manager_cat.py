#!/usr/bin/env python
# -*- coding: utf-8 -*-

"""
ãƒ‡ãƒ¼ã‚¿ç®¡ç†çŒ« - ãƒ‡ãƒ¼ã‚¿ç®¡ç†ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
ãƒªã‚µãƒ¼ãƒçŒ«ã¨ãƒ‡ãƒ¼ã‚¿åˆ†æçŒ«ã‚’çµ±æ‹¬ã—ã€æƒ…å ±åé›†ã¨åˆ†æã‚’ç®¡ç†
"""

import os
from typing import Dict, Any, List, Optional
from agno.agent import Agent
from agents.data_manager.analyzer.data_analyst_cat import DataAnalystCat

class DataManagerCat:
    """
    ãƒ‡ãƒ¼ã‚¿ç®¡ç†çŒ«ã‚¯ãƒ©ã‚¹
    æƒ…å ±åé›†ã¨åˆ†æã‚’çµ±æ‹¬ã™ã‚‹ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
    """
    
    def __init__(self, storage=None, debug_mode: bool = False):
        """
        ãƒ‡ãƒ¼ã‚¿ç®¡ç†çŒ«ã®åˆæœŸåŒ–
        
        Args:
            storage: ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ï¼ˆå…±æœ‰ã™ã‚‹å ´åˆï¼‰
            debug_mode: ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ãƒ•ãƒ©ã‚°
        """
        self.debug_mode = debug_mode
        self.storage = storage
        self.memory = None
        self.agent = None
        
        # ä¸‹ä½ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¸ã®å‚ç…§
        self.research_cat = None
        self.data_analyst_cat = None
        
    def _create_data_manager_agent(self) -> None:
        """
        ãƒ‡ãƒ¼ã‚¿ç®¡ç†çŒ«ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ä½œæˆ
        
        Returns:
            ãªã—
        """
        instructions = """
        ã‚ãªãŸã¯ã€Œãƒ‡ãƒ¼ã‚¿ç®¡ç†çŒ«ã€ã¨ã„ã†åå‰ã®çŒ«çŒ«ã‚«ãƒ³ãƒ‘ãƒ‹ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ç®¡ç†AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã§ã™ã€‚
        ãƒªã‚µãƒ¼ãƒçŒ«ã¨ãƒ‡ãƒ¼ã‚¿åˆ†æçŒ«ã‚’çµ±æ‹¬ã—ã€æƒ…å ±åé›†ã¨åˆ†æã‚’ç®¡ç†ã™ã‚‹å½¹å‰²ã‚’æ‹…ã£ã¦ã„ã¾ã™ã€‚
        
        ã‚ãªãŸã®è²¬å‹™ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ï¼š
        1. ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼çŒ«ã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿é–¢é€£ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ç†è§£ã™ã‚‹
        2. ãƒªã‚µãƒ¼ãƒçŒ«ã«é©åˆ‡ãªæƒ…å ±åé›†æŒ‡ç¤ºã‚’å‡ºã™
        3. ãƒ‡ãƒ¼ã‚¿åˆ†æçŒ«ã«åˆ†æå†…å®¹ã¨å¯è¦–åŒ–æ–¹æ³•ã‚’æŒ‡ç¤ºã™ã‚‹
        4. åé›†ã—ãŸæƒ…å ±ã¨åˆ†æçµæœã‚’çµ±åˆã™ã‚‹
        5. ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼çŒ«ã«çµ±åˆçµæœã‚’å ±å‘Šã™ã‚‹
        
        ä¸‹ä½ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ä»¥ä¸‹ã®2ç¨®é¡ã§ã™ï¼š
        - ãƒªã‚µãƒ¼ãƒçŒ«: Webæ¤œç´¢çŒ«ã¨ç¤¾å†…DBæ¤œç´¢çŒ«ã‚’çµ±æ‹¬ã—ã€æƒ…å ±åé›†ã‚’æ‹…å½“
        - ãƒ‡ãƒ¼ã‚¿åˆ†æçŒ«: çµ±è¨ˆåˆ†æçŒ«ã¨å¯è¦–åŒ–çŒ«ã‚’çµ±æ‹¬ã—ã€ãƒ‡ãƒ¼ã‚¿åˆ†æã¨å¯è¦–åŒ–ã‚’æ‹…å½“
        
        å›ç­”ã¯å¸¸ã«æ—¥æœ¬èªã§è¡Œã„ã€ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ã„ãŸæ­£ç¢ºã§åˆ†ã‹ã‚Šã‚„ã™ã„èª¬æ˜ã‚’å¿ƒãŒã‘ã¦ãã ã•ã„ã€‚
        ã¾ãŸã€çŒ«ã‚‰ã—ã„è¦ªã—ã¿ã‚„ã™ã„å£èª¿ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚
        ä¾‹: ã€Œï½ãƒ‹ãƒ£ã€ã€Œï½ã ã«ã‚ƒã‚“ã€ãªã©ã®è¡¨ç¾ã‚’é©åº¦ã«ä½¿ç”¨ã€‚
        
        åé›†ãƒ»åˆ†æã—ãŸãƒ‡ãƒ¼ã‚¿ã¯ä»¥ä¸‹ã®å½¢å¼ã§æ•´ç†ã—ã¦ãã ã•ã„ï¼š
        1. æƒ…å ±æºï¼ˆå‡ºå…¸ï¼‰
        2. ãƒ‡ãƒ¼ã‚¿ã®æ¦‚è¦
        3. åˆ†æçµæœã®è¦ç‚¹
        4. å¯è¦–åŒ–çµæœï¼ˆè©²å½“ã™ã‚‹å ´åˆï¼‰
        5. è€ƒå¯Ÿã‚„æ´å¯Ÿ
        
        ãƒ‡ãƒ¼ã‚¿ã®æ­£ç¢ºæ€§ã¨ä¿¡é ¼æ€§ã‚’å¸¸ã«é‡è¦–ã—ã€ä¸ç¢ºã‹ãªæƒ…å ±ã«ã¯å¿…ãšãã®æ—¨ã‚’æ˜è¨˜ã—ã¦ãã ã•ã„ã€‚
        """
        
        # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®åˆæœŸåŒ–ï¼ˆãƒ¢ãƒƒã‚¯é–¢é€£ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’å‰Šé™¤ï¼‰
        self.agent = None
        
    def process_request(self, request: str) -> str:
        """
        ãƒ‡ãƒ¼ã‚¿é–¢é€£ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‡¦ç†ã™ã‚‹
        
        Args:
            request: ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼çŒ«ã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ–‡å­—åˆ—
            
        Returns:
            å‡¦ç†çµæœã®å¿œç­”æ–‡å­—åˆ—
        """
        # ä¸‹ä½ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®é…å»¶åˆæœŸåŒ–ï¼ˆå¿…è¦æ™‚ã«åˆæœŸåŒ–ï¼‰
        self._initialize_sub_agents_if_needed()
        
        # ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å‡¦ç†
        if self.debug_mode:
            print(f"Debug: ãƒ‡ãƒ¼ã‚¿ç®¡ç†çŒ«ã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ: {request}")
        
        # ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ç¨®é¡ã‚’åˆ¤æ–­
        request_type = self._determine_request_type(request)
        
        # ãƒ‡ãƒ¼ã‚¿ç®¡ç†çŒ«ã‹ã‚‰ã®å¿œç­”ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹
        response_prefix = """# ğŸ± ãƒ‡ãƒ¼ã‚¿ç®¡ç†çŒ«ã‹ã‚‰ã®å¿œç­”

"""
        
        # ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¿ã‚¤ãƒ—ã«å¿œã˜ãŸå‡¦ç†
        if request_type == "research_only":
            # æƒ…å ±åé›†ã®ã¿ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
            if self.debug_mode:
                print("Debug: ãƒªã‚µãƒ¼ãƒçŒ«ã«è»¢é€")
            
            # ç¾åœ¨ã¯ãƒªã‚µãƒ¼ãƒæ©Ÿèƒ½ã¯æœªå®Ÿè£…
            response = f"""{response_prefix}## ãƒªã‚µãƒ¼ãƒæ©Ÿèƒ½ã«ã¤ã„ã¦

ç”³ã—è¨³ã‚ã‚Šã¾ã›ã‚“ãŒã€ãƒªã‚µãƒ¼ãƒæ©Ÿèƒ½ã¯ç¾åœ¨å®Ÿè£…ä¸­ã§ã™ã€‚
ä»¥ä¸‹ã®ãƒ‡ãƒ¼ã‚¿åˆ†ææ©Ÿèƒ½ã‚’ã”åˆ©ç”¨ãã ã•ã„ï¼š

- å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã®åˆ†æ
- å„ç¨®çµ±è¨ˆåˆ†æ
- ãƒ‡ãƒ¼ã‚¿å¯è¦–åŒ–

ãŠå½¹ã«ç«‹ã¦ãšç”³ã—è¨³ã‚ã‚Šã¾ã›ã‚“ã«ã‚ƒï½ï¼ˆ=^ãƒ»Ï‰ãƒ»^=ï¼‰"""
            
        elif request_type == "analysis_only":
            # ãƒ‡ãƒ¼ã‚¿åˆ†æã®ã¿ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
            if self.debug_mode:
                print("Debug: ãƒ‡ãƒ¼ã‚¿åˆ†æçŒ«ã«è»¢é€")
            
            # åˆ†æå†…å®¹ã«å¿œã˜ã¦é©åˆ‡ãªãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™
            if "å£²ä¸Š" in request and "åˆ†æ" in request:
                # å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã—ã¦åˆ†æçŒ«ã«æ¸¡ã™
                import pandas as pd
                import numpy as np
                
                # ã‚µãƒ³ãƒ—ãƒ«ã®å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
                np.random.seed(123)
                dates = pd.date_range(start='2025-01-01', end='2025-01-31')
                sales_data = pd.DataFrame({
                    'æ—¥ä»˜': dates,
                    'å£²ä¸Šé«˜': np.random.normal(100000, 15000, len(dates)),
                    'å•†å“Aè²©å£²æ•°': np.random.randint(50, 200, len(dates)),
                    'å•†å“Bè²©å£²æ•°': np.random.randint(30, 100, len(dates)),
                    'å•†å“Cè²©å£²æ•°': np.random.randint(10, 50, len(dates)),
                    'é¡§å®¢æ•°': np.random.randint(200, 500, len(dates))
                })
                
                # ãƒ‡ãƒ¼ã‚¿åˆ†æçŒ«ã«åˆ†æã‚’ä¾é ¼
                analysis_request = f"ä»¥ä¸‹ã®å…ˆæœˆï¼ˆ2025å¹´1æœˆï¼‰ã®å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ã¦ãã ã•ã„ï¼š\n\n{request}"
                
                try:
                    # åˆ†æçµæœã‚’å–å¾—
                    analysis_response = self.data_analyst_cat.analyze_data(analysis_request, sales_data)
                    
                    # å¿œç­”ã‚’æ•´å½¢
                    response = f"""# ğŸ“Š å£²ä¸Šãƒ‡ãƒ¼ã‚¿åˆ†æçµæœ

{analysis_response}

ä½•ã‹ä»–ã«ãŠçŸ¥ã‚Šã«ãªã‚ŠãŸã„ã“ã¨ãŒã‚ã‚Œã°ã€ãŠæ°—è»½ã«ãŠå°‹ã­ãã ã•ã„ã«ã‚ƒï½ï¼ˆ=^ãƒ»Ï‰ãƒ»^=ï¼‰"""
                except Exception as e:
                    # ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã¯ä»£æ›¿å¿œç­”
                    print(f"ãƒ‡ãƒ¼ã‚¿åˆ†æã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ: {e}")
                    response = f"""# âš ï¸ ãƒ‡ãƒ¼ã‚¿åˆ†æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ

ç”³ã—è¨³ã‚ã‚Šã¾ã›ã‚“ãŒã€å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã®åˆ†æä¸­ã«å•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸã«ã‚ƒã€‚
ã‚¨ãƒ©ãƒ¼å†…å®¹: {str(e)}

åˆ¥ã®æ–¹æ³•ã§ãŠè©¦ã—ã„ãŸã ãã‹ã€å°‘ã—å¾Œã§ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã«ã‚ƒã€‚"""
            else:
                # ãã®ä»–ã®åˆ†æãƒªã‚¯ã‚¨ã‚¹ãƒˆ
                analysis_response = self.data_analyst_cat.analyze_data(request)
                response = f"{response_prefix}{analysis_response}\n\nãƒ‡ãƒ¼ã‚¿åˆ†æçŒ«ã¨å”åŠ›ã—ã¦åˆ†æã‚’è¡Œã„ã¾ã—ãŸï¼ˆ=^ãƒ»Ï‰ãƒ»^=ï¼‰"
            
        else:
            # æƒ…å ±åé›†ã¨åˆ†æã®ä¸¡æ–¹ã‚’å«ã‚€ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
            if self.debug_mode:
                print("Debug: ãƒªã‚µãƒ¼ãƒçŒ«ã¨ãƒ‡ãƒ¼ã‚¿åˆ†æçŒ«ã«é †æ¬¡è»¢é€")
            
            # ãƒ¢ãƒƒã‚¯å®Ÿè£…ã¨ã—ã¦ã€å£²ä¸Šãƒ‡ãƒ¼ã‚¿åˆ†æã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å ´åˆã¯ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ç”¨æ„
            if "å£²ä¸Š" in request and "åˆ†æ" in request:
                import pandas as pd
                import numpy as np
                
                # ã‚µãƒ³ãƒ—ãƒ«ã®å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
                np.random.seed(123)
                dates = pd.date_range(start='2025-01-01', end='2025-01-31')
                sales_data = pd.DataFrame({
                    'æ—¥ä»˜': dates,
                    'å£²ä¸Šé«˜': np.random.normal(100000, 15000, len(dates)),
                    'å•†å“Aè²©å£²æ•°': np.random.randint(50, 200, len(dates)),
                    'å•†å“Bè²©å£²æ•°': np.random.randint(30, 100, len(dates)),
                    'å•†å“Cè²©å£²æ•°': np.random.randint(10, 50, len(dates)),
                    'é¡§å®¢æ•°': np.random.randint(200, 500, len(dates))
                })
                
                # ãƒ‡ãƒ¼ã‚¿åˆ†æçŒ«ã«ãƒ‡ãƒ¼ã‚¿åˆ†æã‚’ä¾é ¼
                analysis_request = f"ä»¥ä¸‹ã®å…ˆæœˆï¼ˆ2025å¹´1æœˆï¼‰ã®å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ã¦ãã ã•ã„ï¼š\n\n{request}"
                
                try:
                    # åˆ†æçµæœã‚’å–å¾—
                    analysis_response = self.data_analyst_cat.analyze_data(analysis_request, sales_data)
                    
                    # å¿œç­”ã‚’æ•´å½¢
                    response = f"""# ğŸ“Š å£²ä¸Šãƒ‡ãƒ¼ã‚¿åˆ†æçµæœ

ã¾ãšæƒ…å ±ã‚’åé›†ã—ã€æ¬¡ã«ãƒ‡ãƒ¼ã‚¿åˆ†æã‚’è¡Œã„ã¾ã—ãŸã€‚

{analysis_response}

ä»–ã«è©³ã—ãåˆ†æã—ãŸã„ç‚¹ãŒã‚ã‚Œã°æ•™ãˆã¦ãã ã•ã„ã«ã‚ƒï½ï¼ˆ=^ãƒ»Ï‰ãƒ»^=ï¼‰"""
                except Exception as e:
                    # ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã¯ä»£æ›¿å¿œç­”
                    print(f"ãƒ‡ãƒ¼ã‚¿åˆ†æã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ: {e}")
                    response = f"""# âš ï¸ ãƒ‡ãƒ¼ã‚¿åˆ†æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ

ç”³ã—è¨³ã‚ã‚Šã¾ã›ã‚“ãŒã€å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã®åˆ†æä¸­ã«å•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸã«ã‚ƒã€‚
ã‚¨ãƒ©ãƒ¼å†…å®¹: {str(e)}

åˆ¥ã®æ–¹æ³•ã§ãŠè©¦ã—ã„ãŸã ãã‹ã€å°‘ã—å¾Œã§ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã«ã‚ƒã€‚"""
            else:
                # ãã®ä»–ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
                response = f"""{response_prefix}## ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ã¤ã„ã¦

ç”³ã—è¨³ã‚ã‚Šã¾ã›ã‚“ãŒã€ã“ã®ã‚¿ã‚¤ãƒ—ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯ç¾åœ¨å¯¾å¿œã§ãã¾ã›ã‚“ã€‚
ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ‡ãƒ¼ã‚¿åˆ†æãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãŠè©¦ã—ãã ã•ã„ï¼š

- ã€Œå…ˆæœˆã®å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ã¦ã€
- ã€Œå£²ä¸Šé«˜ã®æ¨ç§»ã‚’æ•™ãˆã¦ã€
- ã€Œå•†å“åˆ¥ã®è²©å£²æ•°ã‚’åˆ†æã—ã¦ã€

ãƒ‡ãƒ¼ã‚¿åˆ†æã«é–¢ã™ã‚‹ã”è³ªå•ãŒã‚ã‚Œã°ã€ãŠæ°—è»½ã«ãŠå°‹ã­ãã ã•ã„ã«ã‚ƒï½ï¼ˆ=^ãƒ»Ï‰ãƒ»^=ï¼‰"""
        
        return response
    
    def _determine_request_type(self, request: str) -> str:
        """
        ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ç¨®é¡ã‚’åˆ¤æ–­ã™ã‚‹
        
        Args:
            request: ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ–‡å­—åˆ—
            
        Returns:
            ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¿ã‚¤ãƒ—: "research_only", "analysis_only", "combined"ã®ã„ãšã‚Œã‹
        """
        # æƒ…å ±åé›†é–¢é€£ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
        research_keywords = ["èª¿æŸ»", "æ¤œç´¢", "æƒ…å ±åé›†", "èª¿ã¹ã¦", "æ¢ã—ã¦", "ç¢ºèªã—ã¦"]
        
        # ãƒ‡ãƒ¼ã‚¿åˆ†æé–¢é€£ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
        analysis_keywords = ["åˆ†æ", "çµ±è¨ˆ", "ç›¸é–¢", "å‚¾å‘", "ã‚°ãƒ©ãƒ•", "å¯è¦–åŒ–", "äºˆæ¸¬"]
        
        # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒãƒãƒ³ã‚°
        request_lower = request.lower()
        
        has_research = any(keyword in request_lower for keyword in research_keywords)
        has_analysis = any(keyword in request_lower for keyword in analysis_keywords)
        
        if has_research and not has_analysis:
            return "research_only"
        elif has_analysis and not has_research:
            return "analysis_only"
        else:
            return "combined"
    
    def _initialize_sub_agents_if_needed(self):
        """
        å¿…è¦ã«å¿œã˜ã¦ä¸‹ä½ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’åˆæœŸåŒ–ã™ã‚‹
        """
        # ãƒ‡ãƒ¼ã‚¿åˆ†æçŒ«ã®åˆæœŸåŒ–
        if self.data_analyst_cat is None:
            self.data_analyst_cat = DataAnalystCat(storage=self.storage, debug_mode=self.debug_mode)
            
        # ãƒªã‚µãƒ¼ãƒçŒ«ã®åˆæœŸåŒ–ï¼ˆå°†æ¥å®Ÿè£…ï¼‰
        # if self.research_cat is None:
        #     self.research_cat = ResearchCat(storage=self.storage, debug_mode=self.debug_mode)
